{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrar Quejas - Sistema de Quejas</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ff8c00 0%, #ffb300 40%, #ffd54f 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-6px) scale(1.03);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estados */
        .status-new { background-color: #ffedd5; color: #d97706; border: 1px solid #d97706; }
        .status-in-progress { background-color: #e0f2f1; color: #0f766e; border: 1px solid #0f766e; }
        .status-resolved { background-color: #dcfce7; color: #16a34a; border: 1px solid #16a34a; }
        .status-rejected { background-color: #fee2e2; color: #dc2626; border: 1px solid #dc2626; }

        .filter-btn-active { box-shadow: 0 0 0 2px #ff8c00; }
    </style>
</head>

<body class="flex flex-col min-h-screen text-gray-800">

<!-- HEADER -->
<header class="p-5 flex items-center justify-between bg-black/20 text-white shadow-lg backdrop-blur-md sticky top-0 z-10">
    <a href="{% url 'menu' %}" class="text-2xl hover:text-gray-200 transition">
        <i class="fas fa-arrow-left"></i>
    </a>
    <h1 class="text-2xl md:text-3xl font-extrabold tracking-wide">Panel de Administrador</h1>
</header>

<main class="flex-grow max-w-7xl mx-auto p-4 md:p-8 fade-in">
    <h2 class="text-3xl font-bold text-white drop-shadow-md mb-6 text-center">Revisar Quejas</h2>

    <!-- Filtros -->
    <div class="flex flex-wrap gap-3 mb-6 p-4 bg-white/80 rounded-xl shadow-md backdrop-blur-md" id="filter-buttons">
        <button data-status="all" class="filter-btn filter-btn-active px-4 py-2 text-sm font-medium rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 transition">Todas</button>
        <button data-status="new" class="filter-btn status-new px-4 py-2 text-sm font-medium rounded-full hover:shadow transition">Nuevas</button>
        <button data-status="in_progress" class="filter-btn status-in-progress px-4 py-2 text-sm font-medium rounded-full hover:shadow transition">En Progreso</button>
        <button data-status="resolved" class="filter-btn status-resolved px-4 py-2 text-sm font-medium rounded-full hover:shadow transition">Resueltas</button>
        <button data-status="rejected" class="filter-btn status-rejected px-4 py-2 text-sm font-medium rounded-full hover:shadow transition">Rechazadas</button>
    </div>

    <!-- Lista de quejas -->
    <div id="complaints-admin-list" class="space-y-6">
        <p id="loading-indicator" class="text-center text-gray-500 hidden">
            <i class="fas fa-spinner fa-spin mr-2"></i> Cargando quejas...
        </p>
        <p id="no-complaints-message" class="text-center text-gray-700 p-8 bg-white/80 rounded-xl shadow-md hidden">
            No hay quejas para mostrar.
        </p>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // ðŸ”’ CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const complaintsAdminList = document.getElementById('complaints-admin-list');
    const loadingIndicator = document.getElementById('loading-indicator');
    const noComplaintsMessage = document.getElementById('no-complaints-message');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const API_URL = '/quejas/api/complaints/';
    let currentFilterStatus = 'all';

    function showMessage(type, message, duration = 5000) {
        const msgBox = document.createElement('div');
        msgBox.className = `p-4 mb-3 rounded-lg text-white shadow-xl fixed top-20 right-4 z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} transition-transform transform translate-x-full opacity-0`;
        msgBox.innerHTML = `<i class="fas ${type === 'success' ? 'fa-circle-check' : 'fa-circle-xmark'} mr-2"></i>${message}`;
        document.body.appendChild(msgBox);
        setTimeout(() => { msgBox.classList.remove('translate-x-full', 'opacity-0'); }, 10);
        setTimeout(() => {
            msgBox.classList.add('translate-x-full', 'opacity-0');
            msgBox.addEventListener('transitionend', () => msgBox.remove());
        }, duration);
    }

    function renderComplaint(complaint) {
        const item = document.createElement('div');
        item.id = `complaint-${complaint.id}`;
        item.className = 'card p-6 rounded-xl shadow-md hover:shadow-lg transition flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0';

        const statusText = {
            new: 'Nueva',
            in_progress: 'En progreso',
            resolved: 'Resuelta',
            rejected: 'Rechazada'
        }[complaint.status] || 'Desconocido';

        const reporter = complaint.reporter_username 
            ? `<span class="font-semibold">${complaint.reporter_username}</span>` 
            : `AnÃ³nima (${complaint.reporter_name || 'N/A'})`;

        item.innerHTML = `
            <div class="flex-1">
                <div class="flex items-center space-x-3 mb-2">
                    <span class="text-sm font-bold text-gray-500">ID: ${complaint.id}</span>
                    <span class="px-3 py-1 text-xs font-semibold rounded-full status-${complaint.status}">${statusText}</span>
                </div>
                <h3 class="text-xl font-bold text-gray-900">${complaint.title}</h3>
                <p class="text-sm text-gray-600 truncate">${complaint.description}</p>
                <p class="mt-2 text-xs text-gray-700">
                    <i class="fas fa-tag mr-1 text-yellow-600"></i> ${complaint.category_name}
                    <span class="mx-2 text-gray-300">|</span>
                    <i class="fas fa-user-edit mr-1 text-gray-500"></i> Reportada por: ${reporter}
                </p>
                <p class="mt-1 text-xs text-gray-500"><i class="fas fa-clock mr-1"></i> Creada: ${new Date(complaint.created_at).toLocaleString()}</p>
            </div>

            <div class="w-full md:w-auto flex flex-col items-stretch md:items-end space-y-3">
                <select data-id="${complaint.id}" class="status-select p-2 border border-gray-300 rounded-lg text-sm w-full md:w-40 bg-white cursor-pointer">
                    <option value="new" ${complaint.status === 'new' ? 'selected' : ''}>Nueva</option>
                    <option value="in_progress" ${complaint.status === 'in_progress' ? 'selected' : ''}>En progreso</option>
                    <option value="resolved" ${complaint.status === 'resolved' ? 'selected' : ''}>Resuelta</option>
                    <option value="rejected" ${complaint.status === 'rejected' ? 'selected' : ''}>Rechazada</option>
                </select>
                <button data-id="${complaint.id}" class="delete-btn bg-red-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-red-700 transition">
                    <i class="fas fa-trash-alt mr-1"></i> Eliminar
                </button>
            </div>
        `;
        complaintsAdminList.appendChild(item);
    }

    async function loadComplaints(status = 'all') {
        currentFilterStatus = status;
        complaintsAdminList.innerHTML = '';
        loadingIndicator.classList.remove('hidden');
        noComplaintsMessage.classList.add('hidden');

        let url = API_URL;
        if (status !== 'all') url += `?status=${status}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Error al cargar: ${response.status}`);
            const complaints = await response.json();
            loadingIndicator.classList.add('hidden');
            if (complaints.length === 0) noComplaintsMessage.classList.remove('hidden');
            complaints.forEach(renderComplaint);
        } catch (error) {
            console.error('Error:', error);
            showMessage('error', error.message);
            loadingIndicator.classList.add('hidden');
        }
    }

    async function updateComplaintStatus(id, newStatus) {
        try {
            const response = await fetch(`${API_URL}${id}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ status: newStatus })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Error al actualizar.');
            }
            showMessage('success', `Estado actualizado a ${newStatus}.`);

            // Actualiza solo la tarjeta si no coincide con filtro
            const card = document.getElementById(`complaint-${id}`);
            if (currentFilterStatus !== 'all' && currentFilterStatus !== newStatus) {
                card.remove();
                if (!complaintsAdminList.children.length) noComplaintsMessage.classList.remove('hidden');
            } else {
                const badge = card.querySelector('span.status-new, span.status-in-progress, span.status-resolved, span.status-rejected');
                badge.textContent = {
                    new: 'Nueva',
                    in_progress: 'En progreso',
                    resolved: 'Resuelta',
                    rejected: 'Rechazada'
                }[newStatus];
                badge.className = `px-3 py-1 text-xs font-semibold rounded-full status-${newStatus}`;
            }
        } catch (error) {
            showMessage('error', error.message);
        }
    }

    async function deleteComplaintAdmin(id) {
        if (!confirm(`Â¿Eliminar queja ID ${id}?`)) return;
        try {
            const response = await fetch(`${API_URL}${id}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrftoken }
            });
            if (response.status === 204) {
                showMessage('success', `Queja ${id} eliminada.`);
                const card = document.getElementById(`complaint-${id}`);
                card.remove();
                if (!complaintsAdminList.children.length) noComplaintsMessage.classList.remove('hidden');
            } else {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Error al eliminar.');
            }
        } catch (error) {
            showMessage('error', error.message);
        }
    }

    // EVENTOS
    filterButtons.forEach(btn => {
        btn.addEventListener('click', e => {
            filterButtons.forEach(b => b.classList.remove('filter-btn-active'));
            e.currentTarget.classList.add('filter-btn-active');
            loadComplaints(e.currentTarget.dataset.status);
        });
    });

    complaintsAdminList.addEventListener('change', e => {
        if (e.target.classList.contains('status-select')) {
            updateComplaintStatus(e.target.dataset.id, e.target.value);
        }
    });

    complaintsAdminList.addEventListener('click', e => {
        const btn = e.target.closest('.delete-btn');
        if (btn) deleteComplaintAdmin(btn.dataset.id);
    });

    loadComplaints('all');
});
</script>
</body>
</html>
