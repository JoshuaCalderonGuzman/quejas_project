{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Quejas - Sistema de Quejas</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ff8c00 0%, #ffb300 40%, #ffd54f 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        /* Tarjeta con efecto glassmorphism */
        .complaint-item {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-left: 6px solid #ff8c00;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease-in-out;
        }

        .complaint-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.25);
        }

        /* Badges de estado */
        .status-badge {
            @apply inline-block px-3 py-1 text-xs font-semibold rounded-full uppercase tracking-wider border;
        }
        .status-new {
            background-color: #ffedd5;
            color: #b45309;
            border-color: #d97706;
        }
        .status-in_progress {
            background-color: #e0f2fe;
            color: #075985;
            border-color: #0369a1;
        }
        .status-resolved {
            background-color: #d1fae5;
            color: #065f46;
            border-color: #059669;
        }
        .status-rejected {
            background-color: #fee2e2;
            color: #991b1b;
            border-color: #ef4444;
        }

        /* Animaciones y transiciones */
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mensajes flotantes */
        #message-container > div {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>

<body class="text-gray-800">

<!-- Header -->
<header class="p-4 flex justify-between items-center bg-black/30 text-white shadow-lg backdrop-blur-md sticky top-0 z-10">
    <a href="{% url 'menu' %}" class="text-white hover:text-gray-200 transition">
        <i class="fas fa-arrow-left text-xl"></i>
    </a>
    <h1 class="text-xl md:text-2xl font-extrabold tracking-wide drop-shadow-md">Mis Quejas Reportadas</h1>
    {% if user.is_authenticated %}
    <span class="text-sm font-semibold hidden md:block">üë§ {{ user.username }}</span>
    {% else %}
    <span class="text-sm font-semibold hidden md:block">Usuario An√≥nimo</span>
    {% endif %}
</header>

<main class="max-w-4xl mx-auto p-6 md:p-10 fade-in">

    <!-- Loader -->
    <div id="loading-message" class="text-center text-white my-8">
        <i class="fas fa-spinner fa-spin text-4xl text-white"></i>
        <p class="mt-2">Cargando tus quejas...</p>
    </div>

    <!-- Contenedor de quejas -->
    <div id="complaints-list" class="space-y-6"></div>

    <!-- Contenedor de mensajes -->
    <div id="message-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const complaintsList = document.getElementById('complaints-list');
    const loadingMessage = document.getElementById('loading-message');
    const API_URL = '/quejas/api/complaints/';

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const statusMap = {
        'new': 'Nueva',
        'in_progress': 'En progreso',
        'resolved': 'Resuelta',
        'rejected': 'Rechazada'
    };

    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return new Date(dateString).toLocaleDateString('es-ES', options);
    }

    function showMessage(type, message, duration = 3000) {
        const container = document.getElementById('message-container');
        const alertClass = type === 'success' 
            ? 'bg-green-100 border-green-400 text-green-700' 
            : 'bg-red-100 border-red-400 text-red-700';
        const iconClass = type === 'success' 
            ? 'fa-circle-check text-green-500' 
            : 'fa-circle-exclamation text-red-500';

        const msg = document.createElement('div');
        msg.className = `flex items-center p-4 border-l-4 rounded-lg shadow-lg ${alertClass} max-w-sm`;
        msg.innerHTML = `<i class="fas ${iconClass} mr-3 text-xl"></i><div>${message}</div>`;
        container.appendChild(msg);

        setTimeout(() => {
            msg.classList.add('opacity-0', 'transition-opacity', 'duration-500');
            msg.addEventListener('transitionend', () => msg.remove());
        }, duration);
    }

    async function loadMyComplaints() {
        loadingMessage.classList.remove('hidden');
        complaintsList.innerHTML = '';

        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error(`Error al cargar quejas: ${response.status}`);
            const complaints = await response.json();

            if (complaints.length === 0) {
                complaintsList.innerHTML = `
                    <div class="bg-white/80 backdrop-blur-md p-8 rounded-2xl text-center text-gray-800 border-l-4 border-green-500 shadow-md">
                        <i class="fas fa-file-circle-check text-5xl text-green-600 mb-4"></i>
                        <h3 class="text-lg font-semibold">¬°Todo est√° tranquilo!</h3>
                        <p>No has reportado ninguna queja todav√≠a.</p>
                        <a href="{% url 'nueva_queja' %}" class="mt-3 inline-block text-amber-700 hover:underline font-medium">
                            Reportar una nueva queja <i class="fas fa-arrow-right ml-1"></i>
                        </a>
                    </div>`;
                return;
            }

            complaints.forEach(c => {
                const item = document.createElement('div');
                item.className = 'complaint-item fade-in';
                item.dataset.id = c.id;
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h2 class="text-xl font-bold text-gray-900">${c.title}</h2>
                        <span class="status-badge status-${c.status}">${statusMap[c.status]}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-3">
                        <p><strong>Categor√≠a:</strong> ${c.category_name || 'N/A'}</p>
                        <p><strong>Reportada el:</strong> ${formatDate(c.created_at)}</p>
                    </div>
                    <p class="text-gray-700 mb-4">${c.description.substring(0, 150)}...</p>
                    <div class="flex justify-between items-center border-t pt-3">
                        <a href="#" class="text-amber-600 hover:text-amber-800 text-sm font-medium">
                            Ver Detalles <i class="fas fa-eye ml-1"></i>
                        </a>
                        ${c.status === 'new'
                            ? `<button class="delete-btn text-red-500 hover:text-red-700" data-id="${c.id}">
                                 <i class="fas fa-trash"></i> Eliminar
                               </button>`
                            : `<span class="text-gray-400 text-sm italic">No editable</span>`}
                    </div>`;
                complaintsList.appendChild(item);
            });

        } catch (error) {
            complaintsList.innerHTML = `
                <div class="bg-red-100 p-6 rounded-xl text-center text-red-800 border-l-4 border-red-500 shadow-md">
                    <i class="fas fa-triangle-exclamation text-4xl mb-3"></i>
                    <h3 class="text-lg font-semibold">Error al cargar las quejas</h3>
                    <p>Por favor, intenta de nuevo m√°s tarde.</p>
                </div>`;
            console.error(error);
        } finally {
            loadingMessage.classList.add('hidden');
        }
    }

    async function deleteComplaint(id) {
        if (!confirm(`¬øEliminar la queja #${id}? Esta acci√≥n no se puede deshacer.`)) return;
        const el = document.querySelector(`.complaint-item[data-id="${id}"]`);
        if (el) el.style.opacity = '0.5';
        try {
            const resp = await fetch(`${API_URL}${id}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            if (resp.status === 204) {
                showMessage('success', 'Queja eliminada con √©xito');
                if (el) el.remove();
            } else {
                const err = await resp.json();
                throw new Error(err.detail || 'No se pudo eliminar la queja.');
            }
        } catch (err) {
            showMessage('error', err.message);
            if (el) el.style.opacity = '1';
        }
    }

    complaintsList.addEventListener('click', (e) => {
        const btn = e.target.closest('.delete-btn');
        if (btn) deleteComplaint(btn.dataset.id);
    });

    loadMyComplaints();
});
</script>

</body>
</html>
