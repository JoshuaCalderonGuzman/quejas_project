{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Queja - Sistema de Quejas</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* Definimos la fuente Inter para un look moderno */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            min-height: 100vh;
            /* CAMBIO UI: Fondo m치s contrastado */
            background-color: #e5e7eb; /* Gris 200 */ 
        }
        /* Estilos personalizados para los campos de formulario: m치s suaves y con efecto de profundidad */
        .form-control-custom {
            /* @apply se expande a las clases de Tailwind */
           @apply w-4/5 p-3 border border-gray-300 rounded-xl shadow-inner bg-gray-50
                focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition duration-200;
        }
        /* Estilos para el bot칩n de env칤o */
        .submit-btn {
            /* CAMBIO UI: A침adir un efecto de elevaci칩n (shadow) m치s fuerte y escala al hacer hover */
            @apply bg-amber-600 text-white font-extrabold shadow-xl hover:bg-amber-700 active:bg-amber-800 
                   hover:shadow-2xl hover:scale-[1.01] transition duration-200 ease-in-out;
        }
        /* Color principal: 츼mbar (similar al FF6A00) */
        .bg-primary-amber {
            background-color: #ff8c00; 
        }
        .text-primary-amber {
            color: #ff8c00;
        }
        .text-feedback-success { color: #10B981; } /* Esmeralda 500 */
        .text-feedback-error { color: #EF4444; } /* Rojo 500 */
    </style>
</head>
<body class="bg-gray-100">

<header class="p-4 flex items-center bg-primary-amber shadow-xl sticky top-0 z-10">
    <a href="{% url 'menu' %}" class="text-white text-xl md:text-2xl font-bold hover:opacity-90 transition">
        <i class="fas fa-arrow-left mr-3"></i>Nueva Queja
    </a>
</header>

<div class="container mx-auto p-4 md:p-8">
    
    <div class="max-w-3xl mx-auto bg-white p-6 md:p-10 rounded-3xl shadow-2xl">
        <h2 class="text-3xl font-extrabold text-gray-800 mb-8 text-center border-b-2 pb-4">Reporte su Queja <i class="text-primary-amber fas fa-lightbulb ml-2"></i></h2>
        
        <div id="message-container" class="mb-4">
        </div>

        <form id="new-complaint-form" class="space-y-6">
            
            {% csrf_token %} 
            
            <div>
                <label for="title" class="block text-sm font-bold text-gray-700 mb-1">T칤tulo de la Queja</label>
                <input type="text" id="title" name="title" required 
                        class="form-control-custom" placeholder="Ej: Falla de sem치foro en Av. Central">
            </div>

            <div>
                <label for="category-select" class="block text-sm font-bold text-gray-700 mb-1">Categor칤a</label>
                <select id="category-select" name="category" required 
                        class="form-control-custom">
                    <option value="" disabled selected>Cargando categor칤as...</option>
                </select>
            </div>

            <div>
                <label for="description" class="block text-sm font-bold text-gray-700 mb-1">Descripci칩n Detallada</label>
                <textarea id="description" name="description" rows="5" required 
                            class="form-control-custom" placeholder="Detalle el problema, incluyendo ubicaci칩n y tiempo del incidente..."></textarea>
            </div>
            
            <div class="border border-gray-200 p-6 rounded-2xl bg-gray-50 space-y-4 shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-user-circle text-primary-amber mr-3"></i>Datos de Contacto (Opcional)
                </h3>
                <p class="text-sm text-gray-600">Dejar estos campos vac칤os resulta en un reporte completamente an칩nimo.</p>

                <input type="text" id="reporter_name" name="reporter_name" 
                        class="form-control-custom" placeholder="Su Nombre (Opcional)">
                <input type="email" id="reporter_email" name="reporter_email" 
                        class="form-control-custom" placeholder="Correo Electr칩nico (Opcional)">
                <input type="tel" id="reporter_phone" name="reporter_phone" 
                        class="form-control-custom" placeholder="Tel칠fono (Opcional)">
            </div>
            
            <div>
                <label for="file-input" class="block text-sm font-bold text-gray-700 mb-1">Adjuntar Evidencia (Opcional)</label>
                <input type="file" id="file-input" name="file" multiple
                        class="w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-base file:font-semibold file:bg-amber-100 file:text-amber-800 hover:file:bg-amber-200 transition duration-300">
                <p class="text-xs text-gray-500 mt-1">Puede adjuntar hasta 5 archivos (Im치genes o documentos) a la vez.</p>
            </div>


            <button type="submit" id="submit-btn" 
                class="w-full py-4 rounded-xl text-xl font-extrabold shadow-lg flex items-center justify-center 
                    bg-primary-amber text-white hover:bg-amber-700 transition duration-150">
                <i id="loading-spinner" class="fas fa-spinner fa-spin mr-3 hidden"></i>
                Enviar Queja
            </button>
            
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Definici칩n de URL base de la API (asumimos que est치 en el mismo host)
    // NOTA: Es com칰n que Django a침ada el prefijo de la app (ej: /quejas/api/), si tienes problemas 
    // con la ruta, prueba a usar solo '/api/' si el archivo urls.py est치 configurado as칤 en el proyecto principal.
    const BASE_URL = '/quejas/api/'; 
    const form = document.getElementById('new-complaint-form');
    const categorySelect = document.getElementById('category-select');
    const submitBtn = document.getElementById('submit-btn');
    const loadingSpinner = document.getElementById('loading-spinner');
    const messageContainer = document.getElementById('message-container');

    // -----------------------------------------------------------------
    // Funci칩n para obtener el token CSRF de la cookie
    // -----------------------------------------------------------------
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
                // Manejo de la cookie sin el prefijo 'csrftoken'
                if (cookie.startsWith('csrf_token=')) { 
                    cookieValue = decodeURIComponent(cookie.substring('csrf_token='.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken');


    /**
     * Funci칩n para mostrar mensajes de feedback (칠xito o error).
     * @param {string} type - 'success' o 'error'.
     * @param {string} message - El mensaje a mostrar.
     * @param {number} duration - Duraci칩n en ms antes de ocultar (0 para no ocultar).
     */
    function showMessage(type, message, duration = 5000) {
        const isSuccess = type === 'success';
        // CAMBIO UI: Clases m치s espec칤ficas para mejor impacto visual
        const colorClass = isSuccess ? 'bg-green-50 border-green-500 text-green-700' : 'bg-red-50 border-red-500 text-red-700';
        const icon = isSuccess ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
        const title = isSuccess ? '춰칄xito!' : 'Error:';

        messageContainer.innerHTML = `
            <div class="${colorClass} px-4 py-3 rounded-xl border relative shadow-md animate-pulse-once" role="alert">
                <div class="flex items-center">
                    <i class="${icon} mr-3 text-xl"></i>
                    <div>
                        <strong class="font-extrabold">${title}</strong>
                        <span class="block sm:inline ml-2">${message}</span>
                    </div>
                </div>
            </div>
        `;

        if (duration > 0) {
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, duration);
        }
    }
    
    // =================================================================
    // PETICI칍N DEPENDIENTE (Encadenamiento de Promesas)
    // 1. Cargar categor칤as -> 2. Poblar el selector
    // =================================================================
    async function loadCategories() {
        console.log("Cargando categor칤as...");
        try {
            const response = await fetch(BASE_URL + 'categories/');
            if (!response.ok) {
                throw new Error('No se pudieron cargar las categor칤as: ' + response.statusText);
            }
            const categories = await response.json();
            
            // Limpiar el selector y poblar con datos
            categorySelect.innerHTML = '<option value="" disabled selected>Seleccione una Categor칤a</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
            console.log("Categor칤as cargadas:", categories.length);
        } catch (error) {
            console.error("Error al cargar categor칤as:", error);
            categorySelect.innerHTML = '<option value="" disabled>Error al cargar categor칤as</option>';
            showMessage('error', 'No se pudieron cargar las categor칤as. Intente recargar la p치gina.');
        }
    }

    // =================================================================
    // PETICI칍N POST (Async/Await)
    // 1. Crear Queja (POST) -> 2. Subir Adjuntos (POST)
    // =================================================================
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Mostrar carga y deshabilitar bot칩n
        submitBtn.disabled = true;
        submitBtn.classList.add('bg-gray-400');
        submitBtn.classList.remove('bg-amber-600', 'hover:bg-amber-700', 'active:bg-amber-800'); // Quitar estilos de 치mbar
        loadingSpinner.classList.remove('hidden');
        messageContainer.innerHTML = ''; // Limpiar mensajes anteriores

        // Crear objeto FormData para la queja
        const formData = new FormData(form);
        const complaintData = {};
        
        // Mapear los campos de la queja (excluir 'file' y convertir 'category' a n칰mero)
        for (let [key, value] of formData.entries()) {
             // Excluir 'file' y 'csrfmiddlewaretoken' del JSON
            if (key !== 'file' && key !== 'csrfmiddlewaretoken' && value) {
                complaintData[key] = key === 'category' ? parseInt(value) : value;
            }
        }

        try {
            // 1. Petici칩n para CREAR la Queja
            const createResponse = await fetch(BASE_URL + 'complaints/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken 
                },
                body: JSON.stringify(complaintData)
            });

            if (!createResponse.ok) {
                const errorData = await createResponse.json();
                let errorMsg = JSON.stringify(errorData, null, 2).replace(/[{}\"]/g, '').trim();
                throw new Error(`Error ${createResponse.status}: ${errorMsg}`);
            }

            const newComplaint = await createResponse.json();
            const complaintId = newComplaint.id;
            
            let uploadSuccess = true;
            const files = document.getElementById('file-input').files;

            // 2. Petici칩n para SUBIR Adjuntos (Si existen)
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileFormData = new FormData();
                    fileFormData.append('file', file);
                    // No es necesario a침adir 'complaint' aqu칤 si el ViewSet lo infiere, 
                    // pero es una buena pr치ctica si el serializer lo requiere.

                    // La ruta anidada no requiere el header 'Content-Type': 'application/json' 
                    // ya que se est치 subiendo un archivo (multipart/form-data).
                    const uploadResponse = await fetch(`${BASE_URL}complaints/${complaintId}/attachments/`, {
                        method: 'POST',
                        // Omitir Content-Type para FormData
                        headers: {
                            'X-CSRFToken': csrftoken // 游녣 El token CSRF SI es necesario
                        },
                        body: fileFormData
                    });

                    if (!uploadResponse.ok) {
                        console.error(`Error al subir archivo ${file.name}:`, await uploadResponse.json());
                        uploadSuccess = false;
                        // Continuamos con el resto de archivos
                    }
                }
            }

            // Mostrar mensaje final de 칠xito
            let successMessage = `Queja creada con 칠xito (ID: ${complaintId}).`;
            if (files.length > 0) {
                successMessage += uploadSuccess 
                    ? ` Todos los ${files.length} adjuntos subidos.`
                    : ` La queja se cre칩, pero hubo errores al subir algunos archivos.`;
            }
            showMessage('success', successMessage, 8000);

            // Limpiar formulario
            form.reset();
            categorySelect.value = ''; // Resetear select
            
        } catch (error) {
            console.error("Error completo en la operaci칩n:", error);
            // Asegurar que el mensaje de error es legible
            let displayError = error.message.includes(":") ? error.message.split(":")[1].trim() : error.message;
            // Manejo de casos espec칤ficos de DRF para mejorar el mensaje
            if (displayError.includes("Este campo es requerido")) displayError = "Verifique que todos los campos obligatorios est칠n llenos.";
            if (displayError.length > 100) displayError = 'Error detallado. Revise la consola para m치s informaci칩n.';
            showMessage('error', `No se pudo completar el reporte. ${displayError}`);
            
        } finally {
            // Ocultar carga y re-habilitar bot칩n
            loadingSpinner.classList.add('hidden');
            submitBtn.disabled = false;
            // Restaurar estilos de 치mbar
            submitBtn.classList.add('bg-amber-600', 'hover:bg-amber-700', 'active:bg-amber-800');
            submitBtn.classList.remove('bg-gray-400');
        }
    });

    // Cargar categor칤as al inicio (Petici칩n Dependiente)
    loadCategories();
});
</script>

</body>
</html>