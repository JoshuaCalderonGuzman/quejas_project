{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Queja - Sistema de Quejas</title>
    
    <!-- Tailwind CSS para diseño y responsividad -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome para iconos modernos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* Definimos la fuente Inter para un look moderno */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            min-height: 100vh;
            background-color: #f0f0f0; /* Fondo general */
        }
        /* Estilos personalizados para los campos de formulario: más suaves y con efecto de profundidad */
        .form-control-custom {
            @apply w-full p-3 border border-gray-300 rounded-xl shadow-inner bg-gray-50
                   focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition duration-200;
        }
        /* Estilos para el botón de envío */
        .submit-btn {
            @apply bg-amber-600 text-white hover:bg-amber-700 active:bg-amber-800 transition duration-150;
        }
        /* Color principal: Ámbar (similar al FF6A00) */
        .bg-primary-amber {
            background-color: #ff8c00; 
        }
        .text-primary-amber {
            color: #ff8c00;
        }
        .text-feedback-success { color: #10B981; } /* Esmeralda 500 */
        .text-feedback-error { color: #EF4444; } /* Rojo 500 */
    </style>
</head>
<body class="bg-gray-100">

<!-- CABECERA FIJA Y FUNCIONAL (Fondo Ámbar Principal) -->
<header class="p-4 flex justify-between items-center bg-primary-amber shadow-md">
    <a href="{% url 'menu' %}" class="text-white text-2xl font-bold hover:underline">
        <i class="fas fa-chevron-left mr-2"></i>Nueva Queja
    </a>
</header>

<div class="container mx-auto p-4 md:p-8">
    
    <div class="max-w-3xl mx-auto bg-white p-6 md:p-10 rounded-3xl shadow-2xl">
        <h2 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Reporte su Queja</h2>
        
        <!-- Contenedor de mensajes de feedback -->
        <div id="message-container" class="mb-4">
            <!-- Los mensajes de éxito/error se insertarán aquí -->
        </div>

        <form id="new-complaint-form" class="space-y-6">
            
            <!-- Campo de Título -->
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Título de la Queja</label>
                <input type="text" id="title" name="title" required 
                       class="form-control-custom" placeholder="Ej: Falla de semáforo en Av. Central">
            </div>

            <!-- Campo de Categoría (Petición AJAX Dependiente) -->
            <div>
                <label for="category-select" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                <select id="category-select" name="category" required 
                        class="form-control-custom">
                    <!-- Las opciones se cargarán dinámicamente con AJAX (Encadenamiento de Promesas) -->
                    <option value="" disabled selected>Cargando categorías...</option>
                </select>
            </div>
            
            <!-- Campo de Descripción -->
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descripción Detallada</label>
                <textarea id="description" name="description" rows="5" required 
                          class="form-control-custom" placeholder="Detalle el problema, incluyendo ubicación y tiempo del incidente..."></textarea>
            </div>
            
            <!-- Bloque de Contacto Opcional/Anónimo -->
            <div class="border p-4 rounded-xl bg-gray-50 space-y-4">
                <h3 class="text-lg font-semibold text-gray-800">Datos de Contacto (Opcional)</h3>
                <p class="text-sm text-gray-600">Dejar esto vacío resulta en una queja anónima.</p>

                <input type="text" id="reporter_name" name="reporter_name" 
                       class="form-control-custom" placeholder="Su Nombre (Opcional)">
                <input type="email" id="reporter_email" name="reporter_email" 
                       class="form-control-custom" placeholder="Correo Electrónico (Opcional)">
                <input type="tel" id="reporter_phone" name="reporter_phone" 
                       class="form-control-custom" placeholder="Teléfono (Opcional)">
            </div>
            
            <!-- Campo de Adjuntos (Archivos) -->
            <div>
                <label for="file-input" class="block text-sm font-medium text-gray-700 mb-1">Adjuntar Evidencia (Opcional)</label>
                <input type="file" id="file-input" name="file" multiple
                       class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100 transition duration-150">
                <p class="text-xs text-gray-500 mt-1">Máximo 5 archivos (Imágenes o documentos).</p>
            </div>


            <!-- Botón de Envío -->
            <button type="submit" id="submit-btn" 
                    class="submit-btn w-full py-3 rounded-xl text-lg font-bold shadow-lg flex items-center justify-center">
                <i id="loading-spinner" class="fas fa-spinner fa-spin mr-3 hidden"></i>
                Enviar Queja
            </button>
            
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Definición de URL base de la API (asumimos que está en el mismo host)
    const BASE_URL = '/api/'; 
    const form = document.getElementById('new-complaint-form');
    const categorySelect = document.getElementById('category-select');
    const submitBtn = document.getElementById('submit-btn');
    const loadingSpinner = document.getElementById('loading-spinner');
    const messageContainer = document.getElementById('message-container');

    /**
     * Función para mostrar mensajes de feedback (éxito o error).
     * @param {string} type - 'success' o 'error'.
     * @param {string} message - El mensaje a mostrar.
     * @param {number} duration - Duración en ms antes de ocultar (0 para no ocultar).
     */
    function showMessage(type, message, duration = 5000) {
        const isSuccess = type === 'success';
        const colorClass = isSuccess ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';
        const icon = isSuccess ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
        const title = isSuccess ? '¡Éxito!' : 'Error:';

        messageContainer.innerHTML = `
            <div class="${colorClass} px-4 py-3 rounded-xl border relative" role="alert">
                <div class="flex items-center">
                    <i class="${icon} mr-3 text-xl"></i>
                    <div>
                        <strong class="font-bold">${title}</strong>
                        <span class="block sm:inline ml-2">${message}</span>
                    </div>
                </div>
            </div>
        `;

        if (duration > 0) {
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, duration);
        }
    }
    
    // =================================================================
    // PETICIÓN DEPENDIENTE (Encadenamiento de Promesas)
    // 1. Cargar categorías -> 2. Poblar el selector
    // =================================================================
    function loadCategories() {
        console.log("Cargando categorías...");
        // Usando encadenamiento de promesas
        fetch(BASE_URL + 'categories/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('No se pudieron cargar las categorías: ' + response.statusText);
                }
                return response.json();
            })
            .then(categories => {
                // Limpiar el selector y poblar con datos
                categorySelect.innerHTML = '<option value="" disabled selected>Seleccione una Categoría</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                console.log("Categorías cargadas:", categories.length);
            })
            .catch(error => {
                console.error("Error al cargar categorías:", error);
                categorySelect.innerHTML = '<option value="" disabled>Error al cargar categorías</option>';
                showMessage('error', 'No se pudieron cargar las categorías. Intente recargar la página.');
            });
    }

    // =================================================================
    // PETICIÓN POST (Async/Await)
    // 1. Crear Queja (POST) -> 2. Subir Adjuntos (POST)
    // =================================================================
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Mostrar carga y deshabilitar botón
        submitBtn.disabled = true;
        submitBtn.classList.add('bg-gray-400');
        loadingSpinner.classList.remove('hidden');
        messageContainer.innerHTML = ''; // Limpiar mensajes anteriores

        // Crear objeto FormData para la queja
        const formData = new FormData(form);
        const complaintData = {};
        
        // Mapear los campos de la queja (excluir 'file')
        for (let [key, value] of formData.entries()) {
            if (key !== 'file' && key !== 'category' && value) {
                complaintData[key] = value;
            }
        }
        // Asegurar que category sea un número entero
        complaintData['category'] = parseInt(formData.get('category'));
        

        try {
            // 1. Petición para CREAR la Queja
            const createResponse = await fetch(BASE_URL + 'complaints/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Nota: Asume que las credenciales de autenticación (ej. token CSRF) se manejan por cookies o están desactivadas para este endpoint.
                    // Si se requiere CSRF, se debe obtener el token de un campo oculto o cookie.
                },
                body: JSON.stringify(complaintData)
            });

            if (!createResponse.ok) {
                const errorData = await createResponse.json();
                let errorMsg = JSON.stringify(errorData, null, 2).replace(/[{}\"]/g, '').trim();
                throw new Error(`Error ${createResponse.status}: ${errorMsg}`);
            }

            const newComplaint = await createResponse.json();
            const complaintId = newComplaint.id;
            
            let uploadSuccess = true;
            const files = document.getElementById('file-input').files;

            // 2. Petición para SUBIR Adjuntos (Si existen)
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileFormData = new FormData();
                    fileFormData.append('file', file);
                    // Asignamos la queja creada
                    fileFormData.append('complaint', complaintId); 

                    // Enviamos el adjunto a la ruta anidada: /api/complaints/{id}/attachments/
                    const uploadResponse = await fetch(`${BASE_URL}complaints/${complaintId}/attachments/`, {
                        method: 'POST',
                        body: fileFormData
                        // Nota: Fetch con FormData NO requiere 'Content-Type': 'application/json'. 
                        // El navegador establece automáticamente 'multipart/form-data'.
                    });

                    if (!uploadResponse.ok) {
                        console.error(`Error al subir archivo ${file.name}:`, await uploadResponse.json());
                        uploadSuccess = false;
                        // Continuamos con el resto de archivos, pero marcamos como fallo
                    }
                }
            }

            // Mostrar mensaje final de éxito
            let successMessage = `Queja creada con éxito (ID: ${complaintId}).`;
            if (files.length > 0) {
                successMessage += uploadSuccess 
                    ? ` Todos los ${files.length} adjuntos subidos.`
                    : ` La queja se creó, pero hubo errores al subir algunos archivos.`;
            }
            showMessage('success', successMessage, 8000);

            // Limpiar formulario
            form.reset();
            categorySelect.value = ''; // Resetear select
            
        } catch (error) {
            console.error("Error completo en la operación:", error);
            // Asegurar que el mensaje de error es legible
            let displayError = error.message.includes(":") ? error.message.split(":")[1].trim() : error.message;
            if (displayError.length > 100) displayError = 'Error detallado. Revise la consola para más información.';
            showMessage('error', `No se pudo completar el reporte. ${displayError}`);
            
        } finally {
            // Ocultar carga y re-habilitar botón
            loadingSpinner.classList.add('hidden');
            submitBtn.disabled = false;
            submitBtn.classList.remove('bg-gray-400');
        }
    });

    // Cargar categorías al inicio (Petición Dependiente)
    loadCategories();
});
</script>

</body>
</html>
