{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nueva Queja - Sistema de Quejas</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

body {
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    background: linear-gradient(135deg, #ff8c00 0%, #ffb300 40%, #ffd54f 100%);
    background-attachment: fixed;
    color: #1f2937;
}

.card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease-in-out;
}
.card:hover {
    transform: translateY(-8px) scale(1.03);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
}

.fade-in {
    animation: fadeIn 0.8s ease-in-out;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Inputs y textarea flotantes estilo Material */
.input-container {
    position: relative;
    margin-top: 1.5rem;
}
.input-container input,
.input-container textarea,
.input-container select {
    width: 100%;
    padding: 1rem 1rem 0.5rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 1rem;
    background-color: #ffffff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    outline: none;
    transition: all 0.3s ease;
    font-size: 1rem;
    resize: vertical;
}
.input-container input:focus,
.input-container textarea:focus,
.input-container select:focus {
    border-color: #ff8c00;
    box-shadow: 0 0 0 3px rgba(255,140,0,0.2);
}
.input-container label {
    position: absolute;
    left: 1rem;
    top: 1rem;
    color: #6b7280;
    font-weight: 600;
    pointer-events: none;
    transition: all 0.2s ease-out;
}
.input-container input:focus + label,
.input-container input:not(:placeholder-shown) + label,
.input-container textarea:focus + label,
.input-container textarea:not(:placeholder-shown) + label,
.input-container select:focus + label,
.input-container select:not([value=""]) + label {
    top: -0.5rem;
    left: 0.8rem;
    font-size: 0.8rem;
    color: #ff8c00;
    background-color: #ffffff;
    padding: 0 0.25rem;
}

/* Botón moderno */
.submit-btn {
    width: 100%;
    padding: 1rem;
    font-size: 1.125rem;
    font-weight: 800;
    border-radius: 1.5rem;
    color: #ffffff;
    background: linear-gradient(90deg, #ff8c00 0%, #ffb300 100%);
    box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    transition: all 0.3s ease-in-out;
}
.submit-btn:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 12px 20px rgba(0,0,0,0.3);
}
.submit-btn:active {
    transform: translateY(1px) scale(0.98);
}

/* Spinner dentro del botón */
#loading-spinner {
    margin-right: 0.5rem;
}
</style>
</head>

<body class="flex flex-col min-h-screen">

<!-- HEADER -->
<header class="p-5 flex justify-between items-center bg-black/20 text-white shadow-lg backdrop-blur-md sticky top-0 z-10">
    <a href="{% url 'menu' %}" class="text-2xl font-bold hover:opacity-90 flex items-center transition">
        <i class="fas fa-arrow-left mr-2"></i> Regresar
    </a>
    <h1 class="text-xl md:text-2xl font-extrabold text-white tracking-wide">Nueva Queja</h1>
    <div class="w-8"></div>
</header>

<!-- MAIN -->
<main class="flex-grow flex flex-col items-center justify-center py-12 fade-in">

    <div class="max-w-3xl w-full px-6">
        <div class="card p-10 rounded-3xl shadow-2xl">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-8 text-center flex justify-center items-center gap-2 border-b-2 pb-4">
                <i class="fas fa-lightbulb text-primary-amber"></i> Reporte su Queja
            </h2>

            <div id="message-container" class="mb-4"></div>

            <form id="new-complaint-form" class="space-y-6">
                {% csrf_token %}

                <div class="input-container">
                    <input type="text" id="title" name="title" placeholder=" " required>
                    <label for="title">Título de la Queja</label>
                </div>

                <div class="input-container">
                    <select id="category-select" name="category" placeholder=" " required>
                        <option value="" disabled selected>Cargando categorías...</option>
                    </select>
                    <label for="category-select">Categoría</label>
                </div>

                <div class="input-container">
                    <textarea id="description" name="description" rows="5" placeholder=" " required></textarea>
                    <label for="description">Descripción Detallada</label>
                </div>

                <div class="card p-6 rounded-2xl bg-gray-50 space-y-4 shadow-sm">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <i class="fas fa-user-circle text-primary-amber"></i> Datos de Contacto (Opcional)
                    </h3>
                    <p class="text-sm text-gray-600">Dejar estos campos vacíos resulta en un reporte anónimo.</p>
                    <div class="input-container">
                        <input type="text" id="reporter_name" name="reporter_name" placeholder=" ">
                        <label for="reporter_name">Su Nombre (Opcional)</label>
                    </div>
                    <div class="input-container">
                        <input type="email" id="reporter_email" name="reporter_email" placeholder=" ">
                        <label for="reporter_email">Correo Electrónico (Opcional)</label>
                    </div>
                    <div class="input-container">
                        <input type="tel" id="reporter_phone" name="reporter_phone" placeholder=" ">
                        <label for="reporter_phone">Teléfono (Opcional)</label>
                    </div>
                </div>

                <div class="input-container">
                    <input type="file" id="file-input" name="file" multiple
                        class="w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-base file:font-semibold file:bg-amber-100 file:text-amber-800 hover:file:bg-amber-200 transition duration-300">
                    <label for="file-input">Adjuntar Evidencia (Opcional)</label>
                    <p class="text-xs text-gray-500 mt-1">Puede adjuntar hasta 5 archivos (Imágenes o documentos) a la vez.</p>
                </div>

                <button type="submit" id="submit-btn" class="submit-btn flex items-center justify-center">
                    <i id="loading-spinner" class="fas fa-spinner fa-spin hidden"></i>
                    Enviar Queja
                </button>
            </form>
        </div>
    </div>

</main>

<!-- FOOTER -->
<footer class="text-center text-white py-4 bg-black/30 backdrop-blur-md mt-auto text-sm">
    © 2025 Sistema de Quejas Municipales · Desarrollado con <i class="fa-solid fa-heart text-red-400"></i>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const BASE_URL = '/quejas/api/';
    const form = document.getElementById('new-complaint-form');
    const categorySelect = document.getElementById('category-select');
    const submitBtn = document.getElementById('submit-btn');
    const loadingSpinner = document.getElementById('loading-spinner');
    const messageContainer = document.getElementById('message-container');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(cookie => {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            });
        }
        return cookieValue;
    }
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken');

    function showMessage(type, message, duration = 5000) {
        const isSuccess = type === 'success';
        const colorClass = isSuccess ? 'bg-green-50 border-green-500 text-green-700' : 'bg-red-50 border-red-500 text-red-700';
        const icon = isSuccess ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
        const title = isSuccess ? '¡Éxito!' : 'Error:';
        messageContainer.innerHTML = `
            <div class="${colorClass} px-4 py-3 rounded-xl border relative shadow-md animate-pulse-once" role="alert">
                <div class="flex items-center">
                    <i class="${icon} mr-3 text-xl"></i>
                    <div>
                        <strong class="font-extrabold">${title}</strong>
                        <span class="block sm:inline ml-2">${message}</span>
                    </div>
                </div>
            </div>
        `;
        if (duration > 0) setTimeout(() => messageContainer.innerHTML = '', duration);
    }

    async function loadCategories() {
        try {
            const response = await fetch(BASE_URL + 'categories/');
            if (!response.ok) throw new Error('No se pudieron cargar las categorías: ' + response.statusText);
            const categories = await response.json();
            categorySelect.innerHTML = '<option value="" disabled selected>Seleccione una Categoría</option>';
            categories.forEach(cat => categorySelect.appendChild(new Option(cat.name, cat.id)));
        } catch (error) {
            categorySelect.innerHTML = '<option value="" disabled>Error al cargar categorías</option>';
            showMessage('error', 'No se pudieron cargar las categorías. Recargue la página.');
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        loadingSpinner.classList.remove('hidden');
        const formData = new FormData(form);
        const complaintData = {};
        for (let [key, value] of formData.entries()) {
            if (key !== 'file' && key !== 'csrfmiddlewaretoken' && value) complaintData[key] = key === 'category' ? parseInt(value) : value;
        }
        try {
            const response = await fetch(BASE_URL + 'complaints/', {
                method: 'POST', headers: {'Content-Type':'application/json','X-CSRFToken':csrftoken}, body:JSON.stringify(complaintData)
            });
            if (!response.ok) throw new Error('Error al enviar la queja.');
            const newComplaint = await response.json();
            const complaintId = newComplaint.id;
            const files = document.getElementById('file-input').files;
            let uploadSuccess = true;
            for(let file of files){
                const fd = new FormData();
                fd.append('file', file);
                const r = await fetch(`${BASE_URL}complaints/${complaintId}/attachments/`, {method:'POST', headers:{'X-CSRFToken':csrftoken}, body:fd});
                if(!r.ok) uploadSuccess=false;
            }
            showMessage('success', `Queja creada con éxito (ID: ${complaintId}). ${files.length>0 ? (uploadSuccess?'Todos los archivos subidos.':'Error en algunos archivos.') : ''}`,8000);
            form.reset(); categorySelect.value='';
        } catch(error){
            showMessage('error', `No se pudo completar el reporte. ${error.message}`);
        } finally {
            loadingSpinner.classList.add('hidden'); submitBtn.disabled=false;
        }
    });

    loadCategories();
});
</script>

</body>
</html>
